#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ /login –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /cms/ (–±–µ–∑ —è–∑—ã–∫–æ–≤–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞)
"""

import requests
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def test_login_redirect():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞"""
    base_url = "http://127.0.0.1:8000"
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞...")
    
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
        print("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞...")
        response = requests.get(f"{base_url}/health", timeout=5)
        if response.status_code != 200:
            print("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False
        print("‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω")
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞
        print("2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–æ–≥–∏–Ω–∞...")
        response = requests.get(f"{base_url}/login", timeout=5)
        if response.status_code != 200:
            print("‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–æ–≥–∏–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
            return False
        print("‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–æ–≥–∏–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞")
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ HTML –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π next
        if 'name="next"' in response.text:
            # –ò—â–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ next –≤ HTML
            import re
            next_match = re.search(r'name="next"[^>]*value="([^"]*)"', response.text)
            if next_match:
                next_url = next_match.group(1)
                print(f"üìã –ù–∞–π–¥–µ–Ω next –≤ —Ñ–æ—Ä–º–µ: {next_url}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) next = "/cms/"
                if next_url == "/cms/":
                    print("‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ: /cms/ (–±–µ–∑ —è–∑—ã–∫–æ–≤–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ)")
                    return True
                else:
                    print(f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç: –æ–∂–∏–¥–∞–µ—Ç—Å—è '/cms/', –ø–æ–ª—É—á–µ–Ω '{next_url}'")
                    return False
            else:
                print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω next –≤ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞")
                return False
        else:
            print("‚ùå –§–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ next")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return False
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return False

def test_redirect_function():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é get_cms_redirect_url"""
    print("\nüîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ get_cms_redirect_url...")
    
    try:
        from app.auth.routes import get_cms_redirect_url
        
        # –¢–µ—Å—Ç –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        result_en = get_cms_redirect_url("en")
        print(f"üìã get_cms_redirect_url('en') = '{result_en}'")
        if result_en == "/cms/":
            print("‚úÖ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞")
        else:
            print(f"‚ùå –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫: –æ–∂–∏–¥–∞–µ—Ç—Å—è '/cms/', –ø–æ–ª—É—á–µ–Ω '{result_en}'")
            return False
        
        # –¢–µ—Å—Ç –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
        result_ru = get_cms_redirect_url("ru")
        print(f"üìã get_cms_redirect_url('ru') = '{result_ru}'")
        if result_ru == "/ru/cms/":
            print("‚úÖ –†—É—Å—Å–∫–∏–π —è–∑—ã–∫: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º")
        else:
            print(f"‚ùå –†—É—Å—Å–∫–∏–π —è–∑—ã–∫: –æ–∂–∏–¥–∞–µ—Ç—Å—è '/ru/cms/', –ø–æ–ª—É—á–µ–Ω '{result_ru}'")
            return False
        
        # –¢–µ—Å—Ç –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
        result_ua = get_cms_redirect_url("ua")
        print(f"üìã get_cms_redirect_url('ua') = '{result_ua}'")
        if result_ua == "/ua/cms/":
            print("‚úÖ –£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º")
        else:
            print(f"‚ùå –£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫: –æ–∂–∏–¥–∞–µ—Ç—Å—è '/ua/cms/', –ø–æ–ª—É—á–µ–Ω '{result_ua}'")
            return False
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏: {e}")
        return False

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞")
    print("=" * 60)
    
    # –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏
    function_test_passed = test_redirect_function()
    
    # –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω)
    integration_test_passed = test_login_redirect()
    
    print("\n" + "=" * 60)
    print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:")
    print(f"üîß –§—É–Ω–∫—Ü–∏—è get_cms_redirect_url: {'‚úÖ –ü–†–û–ô–î–ï–ù' if function_test_passed else '‚ùå –ü–†–û–í–ê–õ–ï–ù'}")
    print(f"üåê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: {'‚úÖ –ü–†–û–ô–î–ï–ù' if integration_test_passed else '‚ùå –ü–†–û–í–ê–õ–ï–ù'}")
    
    if function_test_passed and integration_test_passed:
        print("\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´! –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
        print("‚úÖ –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ /login —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /cms/ (–±–µ–∑ —è–∑—ã–∫–æ–≤–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞)")
        sys.exit(0)
    else:
        print("\n‚ùå –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ï–ù–´!")
        sys.exit(1)
