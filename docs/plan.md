# План реализации CMS сайта‑визитки

## Этап 0. Подготовка окружения
- Инициализировать репозиторий, .gitignore, .editorconfig.
- Создать каркас директорий: `app/{auth,cms,site,static,templates,utils,database}`.
- Добавить `requirements.txt` (FastAPI, Uvicorn, Jinja2, python-multipart, passlib[bcrypt], PyJWT, Pillow, python-dotenv, email-validator).
- Настроить `tailwind` (скрипт сборки, `app/static/css/input.css` → `output.css`).
- Создать `.env.example` (JWT_SECRET, GOOGLE_OAUTH toggles, BASE_URL).

Чекпоинт: `uvicorn app.main:app --reload` отдает healthcheck `/health`.

## Этап 1. База данных и слой доступа (без ORM)
- Файл `app/database/db.py`: подключение к SQLite, инициализация таблиц `users`, `texts`, `images`, `seo` (см. PRD).
- Миграции: простая версия — идемпотентный `init.sql` + автопрогон при старте.
- Утилиты для безопасных SQL‑запросов (placeholders, таймауты, возврат кортежей → dict).

Чекпоинт: автосоздание БД при первом старте, smoke‑тест SELECT.

## Этап 2. Аутентификация и безопасность
- Хэширование паролей через bcrypt; валидация email/пароля.
- JWT access‑токены (15 мин), refresh не нужен; хранение в HttpOnly cookie.
- Rate limiting входа (in‑memory счетчик 5/60сек).
- Google OAuth (фича‑флаг через `.env`).
- CSRF middleware для форм POST.

Чекпоинт: защищенный `/cms` редиректит на `/login` без токена, успешный логин создает cookie.

## Этап 3. Шаблоны и базовый UI
- Базовый макет Jinja2: `templates/base.html` с подключением Tailwind, светлая/тёмная тема (data‑theme).
- Компоненты `partials`: шапка с переключателем языка и темы, флеш‑сообщения.
- Формы без WYSIWYG, только `<input>`/`<textarea>`.

Чекпоинт: статические страницы рендерятся, тема переключается и сохраняется в localStorage.

## Этап 4. Модуль Dashboard
- Роут `/cms`: приветствие, дата последнего входа.
- Карточки: количество изображений, активных языков, текстовых блоков.
- Быстрые ссылки на: Тексты, Изображения, SEO, Пользователи (для admin).

Чекпоинт: корректные счетчики из БД, доступ по ролям.

## Этап 5. Редактор текстов
- Таблица `texts(page, key, lang, value)`.
- UI: селект Страница, селект Язык, поля для ключевых текстов; сохранение через fetch POST (JSON), без перезагрузки.
- Сервер: валидация `page/key/lang`, upsert по уникальному ключу.
- Кэш: in‑memory по ключу `(page, lang)`; инвалидация при изменениях.

Чекпоинт: редактирование `home.title` и отображение на публичной главной.

## Этап 6. Загрузка и управление изображениями
- Таблица `images`; поля `type` (logo, slider, background, favicon), `order` для сортировки слайдера.
- Загрузка файлов: прием multipart, проверка типа/размера, сохранение оригинала `/uploads/originals`.
- Оптимизация через Pillow → webp (качество 80%, max width 1920px) в `/uploads/optimized`.
- UI: список слайдов с drag‑and‑drop, удаление, сохранение порядка.
- Инвалидация кэша изображений при изменениях.

Чекпоинт: слайдер на публичной главной использует оптимизированные webp.

## Этап 7. SEO‑панель
- Таблица `seo(page, lang, title, description, keywords)`.
- UI: форма на страницу/язык, предпросмотр `<title>`.
- Сервер: upsert, валидация длин.
- Рендер SEO в публичных шаблонах.

Чекпоинт: уникальные теги для `/ru/about` и `/en/about`.

## Этап 8. Пользователи и роли (admin)
- Список пользователей (email, роль, дата), добавление/удаление, сброс пароля.
- Ограничение доступа к разделу по роли.

Чекпоинт: Editor не видит раздел «Пользователи».

## Этап 9. Публичный сайт
- Роутинг: `/`, `/about`, `/catalog`, `/contacts`; мультиязычные алиасы `/ru/...`, `/en/...`, `/ua/...`.
- Хелпер получения текстов `get_text(page, key, lang)` с кэшем.
- Вставка изображений (логотип, фон, слайдер) из БД.

Чекпоинт: переключение языка меняет контент и SEO.

## Этап 10. Мультиязычность
- Языки по умолчанию: `ru`, `en`, `ua` (configurable).
- Переключатель языка в шапке; определение языка из URL.
- Кэш локализованных блоков; тёплый прогрев при старте (опционально).

Чекпоинт: стабильная работа при быстром переключении языков.

## Этап 11. Кэширование
- In‑memory словарь для текстов/SEO с TTL.
- Файловый кэш для статичных рендеров (опционально): ключ = путь + lang; сброс при изменениях.

Чекпоинт: метрики времени рендера до/после кэша.

## Этап 12. Безопасность и валидация
- Валидация форм (server‑side) и типов файлов.
- CSP, обязательный `SameSite=Lax` для cookies, secure‑флаг в проде.
- Ограничение размеров upload, очистка имени файла.

Чекпоинт: негативные тесты на инъекции, большие файлы и частые логины.

## Этап 13. Сборка и скрипты
- Makefile/PowerShell‑скрипты: `dev`, `tailwind:watch`, `lint`, `run`.
- Документация запуска в `README.md`.

Чекпоинт: один командный сценарий поднимает API и Tailwind watcher.

## Этап 14. Тестирование
- Юнит‑тесты утилит и SQL‑слоя (pytest).
- Интеграционные тесты login, CRUD текстов/SEO/изображений.
- Локальная проверка Lighthouse публичных страниц.

Чекпоинт: все критичные пути покрыты, базовые метрики зелёные.

## Этап 15. Полировка и релиз
- Проход по UI (отступы, адаптивность), иконки, favicon.
- Финальный проход по кэшу: сброс при изменениях, прогрев.
- Заморозка зависимостей (pin версий), экспорт `.env.example`.

Чекпоинт: тег релиза v1.0.0, инструкция деплоя локально.

---

## Контрольные артефакты
- `docs/architecture.md`: актуализировать по итогам каждого этапа с ключевыми решениями.
- Диаграммы роутинга CMS/публичных страниц (ссылки в `docs`).

## Таймлайн (грубая оценка)
- Этапы 0–3: 1–2 дня
- Этапы 4–9: 3–4 дня
- Этапы 10–12: 1 день
- Этапы 13–15: 1–2 дня

## Риски и обходные пути
- Производительность Pillow на больших изображениях → ограничить размеры при приёме, offload в фоновую задачу (опционально).
- Рост объёма текстов → индексы по `(page, lang)`, пагинация в UI.
- Отсутствие ORM → аккуратные обёртки над `sqlite3`, тесты на SQL‑инъекции.

## Критерии приёмки
- Все разделы CMS доступны и корректно ограничены ролями.
- Публичные страницы читают БД и корректно локализуются.
- SEO‑теги различаются по языкам и страницам.
- Изображения оптимизируются и отдаются webp, оригиналы сохраняются.
- Кэш ускоряет ответы; инвалидация предсказуема.

