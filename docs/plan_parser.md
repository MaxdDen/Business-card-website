# План реализации механизма автоматического парсинга переменных шаблонов

## Обзор

Механизм автоматического парсинга переменных позволяет извлекать переменные из HTML шаблонов и автоматически добавлять их в базу данных для редактирования пользователями CMS. Это обеспечивает синхронизацию между кодом и контентом без ручного вмешательства.

## Этап 1: Анализ и проектирование

### 1.1 Определение паттернов переменных

**Стандартные паттерны:**
```
{{ texts.ключ }}           - основные текстовые переменные
{{ seo.ключ }}            - SEO переменные  
{{ images.ключ }}         - переменные изображений
{{ lang }}                - переменная языка
{{ supported_languages }} - список языков
```

**Условные конструкции:**
```
{% if texts.ключ %}       - проверка наличия переменной
{% if lang == 'ru' %}     - проверка языка
{% for item in items %}   - циклы (исключаем из парсинга)
```

### 1.2 Маппинг файлов к страницам

```
app/templates/public/home.html     → page: 'home'
app/templates/public/about.html    → page: 'about'  
app/templates/public/catalog.html  → page: 'catalog'
app/templates/public/contacts.html → page: 'contacts'
```

### 1.3 Структура переменных в БД

```
Таблица: texts
- page: 'home', 'about', 'catalog', 'contacts'
- key: 'title', 'subtitle', 'description', 'cta_text', 'phone', 'address'
- lang: 'en', 'ru', 'ua'
- value: '' (пустое по умолчанию)
```

## Этап 2: Создание парсера шаблонов

### 2.1 Модуль `app/utils/template_parser.py`

**Основные функции:**
- `extract_variables_from_file()` - извлечение переменных из одного файла
- `parse_all_templates()` - парсинг всех шаблонов
- `get_page_from_path()` - определение страницы по пути
- `sync_to_database()` - синхронизация с БД

### 2.2 Логика извлечения переменных

**Регулярные выражения:**
```python
# Основные переменные
{{ texts.ключ }} → texts.ключ → ключ
{{ seo.ключ }}   → seo.ключ   → ключ

# Исключения
{{ lang }}                    - системная переменная
{{ supported_languages }}    - системная переменная  
{{ loop.index }}             - переменная цикла
{{ request }}                - объект запроса
```

### 2.3 Валидация переменных

**Правильные ключи:**
- `title`, `subtitle`, `description` - основные тексты
- `cta_text`, `button_text` - кнопки
- `phone`, `address`, `email` - контакты
- `meta_title`, `meta_description` - SEO

**Недопустимые ключи:**
- Системные переменные (`lang`, `request`)
- Переменные циклов (`loop.index`, `loop.first`)
- Временные переменные (`temp`, `tmp`)

## Этап 3: Интеграция в приложение

### 3.1 Автоматический запуск при старте

**В `app/main.py`:**
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # ... существующий код ...
    
    # Автоматический парсинг при запуске
    from app.utils.template_parser import TemplateParser
    parser = TemplateParser()
    parser.sync_variables_to_database()
    
    yield
```

### 3.2 API endpoints для ручного управления

**Новые роуты в `app/cms/routes.py`:**
- `GET /cms/api/template-variables` - получить все переменные
- `POST /cms/api/sync-template-variables` - синхронизировать вручную
- `GET /cms/api/missing-variables` - показать отсутствующие переменные

### 3.3 UI для управления

**Новая страница CMS:**
- Список найденных переменных по страницам
- Отсутствующие переменные (красным)
- Кнопка "Синхронизировать"
- Логи операций

## Этап 4: Детальное описание переменных

### 4.1 Синтаксис описания переменных в HTML

**Базовый синтаксис:**
```html
<!-- Простые переменные -->
<h1>{{ texts.title }}</h1>
<p>{{ texts.description }}</p>

<!-- С fallback значениями -->
<h1>{{ texts.title or 'Заголовок по умолчанию' }}</h1>

<!-- Условные переменные -->
{% if texts.subtitle %}
<h2>{{ texts.subtitle }}</h2>
{% endif %}
```

**SEO переменные:**
```html
<title>{{ seo.title }}</title>
<meta name="description" content="{{ seo.description }}">
<meta name="keywords" content="{{ seo.keywords }}">
```

**Переменные изображений:**
```html
<img src="/{{ images.logo.path }}" alt="{{ images.logo.alt }}">
```

### 4.2 Правила именования переменных

**Структура: `namespace.key`**
- `texts.title` - заголовок страницы
- `texts.subtitle` - подзаголовок
- `texts.description` - описание
- `texts.cta_text` - текст кнопки
- `texts.phone` - телефон
- `texts.address` - адрес

**SEO переменные:**
- `seo.title` - мета-заголовок
- `seo.description` - мета-описание  
- `seo.keywords` - ключевые слова

**Изображения:**
- `images.logo` - логотип
- `images.background` - фоновое изображение
- `images.slider` - изображения слайдера

### 4.3 Поддерживаемые типы переменных

**Текстовые переменные:**
```html
<!-- Заголовки -->
{{ texts.title }}
{{ texts.subtitle }}
{{ texts.heading }}

<!-- Описания -->
{{ texts.description }}
{{ texts.content }}
{{ texts.summary }}

<!-- Кнопки и ссылки -->
{{ texts.cta_text }}
{{ texts.button_text }}
{{ texts.link_text }}

<!-- Контакты -->
{{ texts.phone }}
{{ texts.email }}
{{ texts.address }}
{{ texts.working_hours }}
```

**SEO переменные:**
```html
{{ seo.title }}
{{ seo.description }}
{{ seo.keywords }}
{{ seo.og_title }}
{{ seo.og_description }}
```

**Системные переменные (исключаются из парсинга):**
```html
{{ lang }}                    <!-- Текущий язык -->
{{ request }}                <!-- Объект запроса -->
{{ supported_languages }}    <!-- Список языков -->
{{ language_urls }}          <!-- URL для языков -->
```

### 4.4 Условные конструкции

**Простые условия:**
```html
{% if texts.subtitle %}
<h2>{{ texts.subtitle }}</h2>
{% endif %}

{% if texts.phone %}
<p>Телефон: {{ texts.phone }}</p>
{% endif %}
```

**Условия по языку:**
```html
{% if lang == 'ru' %}
<h1>{{ texts.title }}</h1>
{% elif lang == 'en' %}
<h1>{{ texts.title }}</h1>
{% endif %}
```

**Циклы (исключаются из парсинга):**
```html
{% for image in slider_images %}
<img src="/{{ image.path }}" alt="{{ image.alt }}">
{% endfor %}
```

## Этап 5: Алгоритм работы парсера

### 5.1 Пошаговый алгоритм

**Шаг 1: Сканирование файлов**
```
1. Найти все .html файлы в app/templates/public/
2. Для каждого файла определить страницу
3. Извлечь все переменные с помощью regex
```

**Шаг 2: Фильтрация переменных**
```
1. Исключить системные переменные (lang, request, etc.)
2. Исключить переменные циклов (loop.*)
3. Оставить только texts.* и seo.* переменные
```

**Шаг 3: Извлечение ключей**
```
texts.title → key: 'title'
seo.description → key: 'description'
```

**Шаг 4: Синхронизация с БД**
```
1. Для каждой (page, key) пары:
   - Проверить существование в БД
   - Если нет - добавить для всех языков с пустым значением
   - Если есть - пропустить
```

### 5.2 Обработка ошибок

**Типы ошибок:**
- Файл не найден
- Некорректный синтаксис HTML
- Ошибка записи в БД
- Конфликт переменных

**Стратегии обработки:**
- Логирование всех ошибок
- Продолжение работы при ошибках
- Уведомления пользователя
- Откат изменений при критических ошибках

## Этап 6: Тестирование и валидация

### 6.1 Тестовые сценарии

**Сценарий 1: Новые переменные**
```
1. Добавить {{ texts.new_field }} в home.html
2. Запустить синхронизацию
3. Проверить появление в БД
4. Проверить появление в CMS
```

**Сценарий 2: Изменение переменных**
```
1. Изменить {{ texts.title }} на {{ texts.main_title }}
2. Запустить синхронизацию
3. Проверить добавление main_title
4. Проверить сохранение старого title
```

**Сценарий 3: Удаление переменных**
```
1. Удалить {{ texts.old_field }} из шаблона
2. Запустить синхронизацию
3. Проверить сохранение в БД (не удаляется автоматически)
```

### 6.2 Валидация результатов

**Проверки:**
- Все переменные из шаблонов найдены в БД
- Нет лишних переменных в БД
- Корректность языковых версий
- Производительность парсинга

## Этап 7: Документация и обучение

### 7.1 Документация для разработчиков

**Правила добавления переменных:**
```
1. Используйте стандартные имена: title, subtitle, description
2. Группируйте по namespace: texts.*, seo.*
3. Избегайте системных имен: lang, request, loop
4. Тестируйте после добавления
```

**Примеры использования:**
```html
<!-- ✅ Правильно -->
<h1>{{ texts.title }}</h1>
<p>{{ texts.description }}</p>

<!-- ❌ Неправильно -->
<h1>{{ title }}</h1>
<p>{{ lang }}</p>
```

### 7.2 Инструкции для пользователей

**Как работает система:**
```
1. Разработчик добавляет переменную в HTML
2. Система автоматически находит её при запуске
3. Переменная появляется в CMS для редактирования
4. Пользователь заполняет значения для всех языков
```

**Управление переменными:**
```
1. Зайти в CMS → "Переменные шаблонов"
2. Посмотреть список найденных переменных
3. Нажать "Синхронизировать" для обновления
4. Заполнить значения в разделе "Тексты"
```

## Этап 8: Реализация

### 8.1 Создание модуля парсера

**Файл: `app/utils/template_parser.py`**
- Класс `TemplateParser`
- Методы извлечения переменных
- Синхронизация с БД
- Логирование операций

### 8.2 Интеграция в приложение

**Обновления:**
- `app/main.py` - автоматический запуск
- `app/cms/routes.py` - API endpoints
- `app/templates/` - UI для управления

### 8.3 Тестирование

**Автотесты:**
- Парсинг различных типов переменных
- Синхронизация с БД
- Обработка ошибок
- Производительность

## Этап 9: Развертывание и мониторинг

### 9.1 Развертывание

**Порядок действий:**
1. Создание модуля парсера
2. Интеграция в приложение
3. Создание UI для управления
4. Тестирование на dev окружении
5. Развертывание на production

### 9.2 Мониторинг

**Метрики:**
- Количество найденных переменных
- Время выполнения парсинга
- Ошибки синхронизации
- Использование памяти

**Логирование:**
- Все операции парсинга
- Ошибки и предупреждения
- Статистика использования
- Производительность

## Заключение

Данный план обеспечивает полную автоматизацию процесса управления переменными шаблонов с минимальным участием разработчиков и максимальным удобством для пользователей CMS. Механизм позволяет:

- Автоматически находить новые переменные в HTML
- Синхронизировать их с базой данных
- Предоставлять удобный интерфейс для управления
- Обеспечивать стабильную работу системы

Реализация этого плана значительно упростит процесс добавления нового контента и обеспечит синхронизацию между кодом и CMS.
