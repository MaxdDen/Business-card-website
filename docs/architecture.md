## Этап 0 — базовая архитектура и окружение

- Ядро: FastAPI (`app/main.py`) с healthcheck `GET /health`.
- Jinja2 шаблоны: `app/templates` с базовым макетом и партиалами.
- Структура каталогов: `app/{auth,cms,site,static,templates,utils,database}`.
- Конфигурация окружения: `.env` (пример в `.env.example`), загрузка через `python-dotenv`.
- Стили: TailwindCSS 4.1, вход `app/static/css/input.css` (`@import "tailwindcss";`), выход `app/static/css/output.css`; сборка через `@tailwindcss/cli` скрипты в `package.json`.
  - Подключение статики через `app.mount('/static', ...)`.
- Зависимости Python: перечислены в `requirements.txt` (FastAPI, Uvicorn, Jinja2, python-multipart, passlib[bcrypt], PyJWT, Pillow, python-dotenv, email-validator).
- Базовые правила репозитория: `.gitignore`, `.editorconfig`.

Решения:
- Минимальный HTTP‑интерфейс для проверки живости сервиса без БД.
- Базовый UI: `/` рендерится через Jinja2, поддержка светлой/тёмной темы (localStorage + `data-theme`), Tailwind `dark:` включён через `@variant dark (&:where([data-theme="dark"], [data-theme="dark"] *));` в `input.css`.
- Tailwind внедряется на уровне сборки, без фреймворков UI.
- Мультиязычность будет реализована далее, но языки по умолчанию заданы через `.env`.

## Этап 1 — база данных и слой доступа (без ORM)

- Хранилище: SQLite в `data/app.db`, включён `PRAGMA foreign_keys = ON` и WAL.
- Схема: `app/database/init.sql` (идемпотентный скрипт, таблицы `users`, `texts`, `images`, `seo`).
- Инициализация: выполняется в lifespan-хуке приложения (`ensure_database_initialized`).
- Доступ: модуль `app/database/db.py` с хелперами `query_one`, `query_all`, `execute`, `executemany` и словарным `row_factory`.
- Дымовой тест: `smoke_test()` выполняется на старте, логирует результат.

## Этап 2 — аутентификация и безопасность

- Логины через email+пароль, проверка и хэширование с bcrypt.
- JWT access-токен (15 мин) хранится в HttpOnly cookie `access_token`.
- Rate limiting логина: 5 попыток/60 сек (in-memory sliding window).
- CSRF middleware для всех небезопасных методов; токен в cookie + заголовок `x-csrf-token`.
- Защищённые роуты `/cms/*` требуют валидного JWT; доступ проверяется в `AuthRedirectMiddleware` (cookie -> JWT -> пользователь в БД). При отсутствии/некорректности токена выполняется редирект на `/login`.
- Эндпоинты аутентификации:
  - `GET /login` — форма входа (тёмная тема, современный UI)
  - `POST /login` — валидация email, пароль ≥ 8, проверка bcrypt, установка HttpOnly JWT cookie, редирект на `/cms`
  - `GET /register` — форма регистрации (тёмная тема)
  - `POST /register` — валидация email и пароля, проверка уникальности, bcrypt-хэш, автологин, редирект на `/cms`
  - `POST /logout` — удаление cookie и редирект на `/login`

## Этап 3 — шаблоны и базовый UI

- Jinja2 шаблонизация: `app/templates/base.html` с подключением Tailwind, светлая/тёмная тема через `data-theme` атрибут.
- Партиалы: `app/templates/partials/header.html` с переключателем темы и навигацией.
- Статика: монтирование через `app.mount('/static', ...)`, подключение `output.css` в базовом шаблоне.
- Tailwind 4.1: `@import "tailwindcss"` в `input.css`, сборка через `@tailwindcss/cli`, тёмный режим через `@variant dark (&:where([data-theme="dark"], [data-theme="dark"] *));`.
- Роутинг: `/` рендерится через `templates.TemplateResponse("index.html", {"request": request})`.

Решения:
- Базовый UI без WYSIWYG, только `<input>`/`<textarea>` формы.
- Переключение темы сохраняется в localStorage, применяется при загрузке страницы.
- Контейнер с `max-w-6xl` для адаптивности, тёмные классы `dark:` работают корректно.

## Этап 4 — модуль Dashboard

- CMS роуты: `app/cms/routes.py` с защищёнными эндпоинтами `/cms/*`.
- Dashboard: главная панель с приветствием, статистикой и быстрыми ссылками.
- Статистика: подсчёт изображений, языков, текстов, пользователей через SQL-запросы.
- Шаблоны: `dashboard.html`, `texts.html`, `images.html`, `seo.html`, `users.html`.
- Роли: проверка доступа к разделу "Пользователи" только для admin.
- UI: современный дизайн с карточками статистики и быстрыми действиями.

Решения:
- Статистика загружается из БД в реальном времени через функции `get_dashboard_stats()`.
- Разделение доступа по ролям: admin видит все разделы, editor не видит "Пользователи".
- Адаптивный дизайн с использованием Tailwind CSS 4.1 и тёмной темы.
- Заглушки для будущих разделов с информативными сообщениями.

## Этап 5 — редактор текстов

- UI: полноценный интерфейс редактирования с селектами страницы/языка и полями для ключевых текстов.
- API: эндпоинты `GET /cms/api/texts` и `POST /cms/api/texts` для получения и сохранения текстов.
- Валидация: проверка допустимых страниц (home, about, catalog, contacts) и языков (ru, en, ua).
- Кэширование: in-memory кэш с TTL 5 минут, инвалидация при изменениях.
- CRUD операции: UPSERT для сохранения, удаление пустых значений.
- AJAX: сохранение без перезагрузки страницы через fetch API.

Решения:
- Кэш реализован в `app/utils/cache.py` с thread-safe операциями и TTL.
- Валидация ключей текстов: title, subtitle, description, cta_text, phone, address.
- Автотест `tests/auto_tests/test_texts_editor.py` проверяет все компоненты системы.
- UI использует современный дизайн с уведомлениями об успехе/ошибках.

## Этап 5.1 — исправления редактора текстов

- **Проблемы:** Кнопка "Загрузить тексты" была избыточной, значения по умолчанию не установлены, сохранение данных не работало из-за неправильного SQL-запроса.
- **Исправления:**
  - Убрана кнопка "Загрузить тексты", добавлена автоматическая загрузка при открытии страницы.
  - Установлены значения по умолчанию: Главная страница + английский язык.
  - Исправлен SQL-запрос для сохранения данных (заменен ON CONFLICT на проверку существования записи).
  - Добавлена автоматическая загрузка данных при изменении страницы или языка.
- **Тестирование:** Создан автотест `tests/auto_tests/test_texts_editor_fixed.py` для проверки всех исправлений.
- **Результат:** Редактор текстов теперь работает корректно с автоматической загрузкой и сохранением данных.

## Этап 5.2 — исправление CSRF проблемы

- **Проблема:** API endpoints требовали CSRF токены, что вызывало ошибку 403 при сохранении текстов через JavaScript.
- **Причина:** CSRF middleware применялся ко всем запросам, включая API endpoints.
- **Исправление:** Добавлено исключение для API endpoints (`/cms/api/*`) в CSRF middleware.
- **Изменения:**
  - Обновлен `app/auth/csrf.py` - API endpoints пропускают CSRF проверку.
  - Убраны CSRF токены из JavaScript запросов в `app/templates/texts.html`.
  - Обычные формы (логин, регистрация) остаются защищенными CSRF.
- **Тестирование:** Создан автотест `tests/auto_tests/test_csrf_fix.py` для проверки исправления.
- **Результат:** Сохранение и загрузка текстов теперь работают без ошибок 403.

## Этап 6 — загрузка и управление изображениями

- **API endpoints:** Созданы endpoints для загрузки, получения, удаления и изменения порядка изображений (`/cms/api/images/*`).
- **Валидация:** Проверка типа файла (JPG, PNG, WebP, ICO), размера (максимум 2MB) и корректности изображения.
- **Оптимизация:** Автоматическая оптимизация изображений через Pillow с конвертацией в WebP (качество 80%, максимальная ширина 1920px).
- **Хранение:** Сохранение оригинальных файлов в `/uploads/originals` и оптимизированных в `/uploads/optimized`.
- **UI:** Полноценный интерфейс управления изображениями с drag-and-drop сортировкой для слайдера.
- **Кэширование:** In-memory кэш изображений с TTL 10 минут и автоматическая инвалидация при изменениях.
- **Типы изображений:** Поддержка типов logo, slider, background, favicon с отдельным управлением.
- **Тестирование:** Создан автотест `tests/auto_tests/test_images_management.py` для проверки всех компонентов.
- **Результат:** Полнофункциональная система управления изображениями с оптимизацией и кэшированием.

## Этап 7 — SEO-панель

- **API endpoints:** Созданы endpoints для получения и сохранения SEO данных (`/cms/api/seo`).
- **Валидация:** Проверка длин полей (title ≤ 60, description ≤ 160, keywords ≤ 255 символов) согласно SEO рекомендациям.
- **UI:** Полноценный интерфейс с формой редактирования и предпросмотром результатов в стиле Google Search.
- **Предпросмотр:** Реальное время отображения как будет выглядеть страница в поисковиках.
- **HTML генерация:** Автоматическая генерация HTML кода для мета-тегов.
- **Мультиязычность:** Поддержка SEO для всех страниц (home, about, catalog, contacts) и языков (ru, en, ua).
- **UPSERT операции:** Автоматическое создание или обновление SEO записей в таблице `seo`.
- **Тестирование:** Создан автотест `tests/auto_tests/test_seo_management.py` для проверки всех компонентов.
- **Результат:** Полнофункциональная SEO-панель с валидацией, предпросмотром и мультиязычной поддержкой.