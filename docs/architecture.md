## Этап 0 — базовая архитектура и окружение

- Ядро: FastAPI (`app/main.py`) с healthcheck `GET /health`.
- Jinja2 шаблоны: `app/templates` с базовым макетом и партиалами.
- Структура каталогов: `app/{auth,cms,site,static,templates,utils,database}`.
- Конфигурация окружения: `.env` (пример в `.env.example`), загрузка через `python-dotenv`.
- Стили: TailwindCSS 4.1, вход `app/static/css/input.css` (`@import "tailwindcss";`), выход `app/static/css/output.css`; сборка через `@tailwindcss/cli` скрипты в `package.json`.
  - Подключение статики через `app.mount('/static', ...)`.
- Зависимости Python: перечислены в `requirements.txt` (FastAPI, Uvicorn, Jinja2, python-multipart, passlib[bcrypt], PyJWT, Pillow, python-dotenv, email-validator).
- Базовые правила репозитория: `.gitignore`, `.editorconfig`.

Решения:
- Минимальный HTTP‑интерфейс для проверки живости сервиса без БД.
- Базовый UI: `/` рендерится через Jinja2, поддержка светлой/тёмной темы (localStorage + `data-theme`), Tailwind `dark:` включён через `@variant dark (&:where([data-theme="dark"], [data-theme="dark"] *));` в `input.css`.
- Tailwind внедряется на уровне сборки, без фреймворков UI.
- Мультиязычность будет реализована далее, но языки по умолчанию заданы через `.env`.

## Этап 1 — база данных и слой доступа (без ORM)

- Хранилище: SQLite в `data/app.db`, включён `PRAGMA foreign_keys = ON` и WAL.
- Схема: `app/database/init.sql` (идемпотентный скрипт, таблицы `users`, `texts`, `images`, `seo`).
- Инициализация: выполняется в lifespan-хуке приложения (`ensure_database_initialized`).
- Доступ: модуль `app/database/db.py` с хелперами `query_one`, `query_all`, `execute`, `executemany` и словарным `row_factory`.
- Дымовой тест: `smoke_test()` выполняется на старте, логирует результат.

## Этап 2 — аутентификация и безопасность

- Логины через email+пароль, проверка и хэширование с bcrypt.
- JWT access-токен (15 мин) хранится в HttpOnly cookie `access_token`.
- Rate limiting логина: 5 попыток/60 сек (in-memory sliding window).
- CSRF middleware для всех небезопасных методов; токен в cookie + заголовок `x-csrf-token`.
- Защищённые роуты `/cms/*` требуют валидного JWT; доступ проверяется в `AuthRedirectMiddleware` (cookie -> JWT -> пользователь в БД). При отсутствии/некорректности токена выполняется редирект на `/login`.
- Эндпоинты аутентификации:
  - `GET /login` — форма входа (тёмная тема, современный UI)
  - `POST /login` — валидация email, пароль ≥ 8, проверка bcrypt, установка HttpOnly JWT cookie, редирект на `/cms`
  - `GET /register` — форма регистрации (тёмная тема)
  - `POST /register` — валидация email и пароля, проверка уникальности, bcrypt-хэш, автологин, редирект на `/cms`
  - `POST /logout` — удаление cookie и редирект на `/login`

## Этап 3 — шаблоны и базовый UI

- Jinja2 шаблонизация: `app/templates/base.html` с подключением Tailwind, светлая/тёмная тема через `data-theme` атрибут.
- Партиалы: `app/templates/partials/header.html` с переключателем темы и навигацией.
- Статика: монтирование через `app.mount('/static', ...)`, подключение `output.css` в базовом шаблоне.
- Tailwind 4.1: `@import "tailwindcss"` в `input.css`, сборка через `@tailwindcss/cli`, тёмный режим через `@variant dark (&:where([data-theme="dark"], [data-theme="dark"] *));`.
- Роутинг: `/` рендерится через `templates.TemplateResponse("index.html", {"request": request})`.

Решения:
- Базовый UI без WYSIWYG, только `<input>`/`<textarea>` формы.
- Переключение темы сохраняется в localStorage, применяется при загрузке страницы.
- Контейнер с `max-w-6xl` для адаптивности, тёмные классы `dark:` работают корректно.

## Этап 4 — модуль Dashboard

- CMS роуты: `app/cms/routes.py` с защищёнными эндпоинтами `/cms/*`.
- Dashboard: главная панель с приветствием, статистикой и быстрыми ссылками.
- Статистика: подсчёт изображений, языков, текстов, пользователей через SQL-запросы.
- Шаблоны: `dashboard.html`, `texts.html`, `images.html`, `seo.html`, `users.html`.
- Роли: проверка доступа к разделу "Пользователи" только для admin.
- UI: современный дизайн с карточками статистики и быстрыми действиями.

Решения:
- Статистика загружается из БД в реальном времени через функции `get_dashboard_stats()`.
- Разделение доступа по ролям: admin видит все разделы, editor не видит "Пользователи".
- Адаптивный дизайн с использованием Tailwind CSS 4.1 и тёмной темы.
- Заглушки для будущих разделов с информативными сообщениями.

## Этап 5 — редактор текстов

- UI: полноценный интерфейс редактирования с селектами страницы/языка и полями для ключевых текстов.
- API: эндпоинты `GET /cms/api/texts` и `POST /cms/api/texts` для получения и сохранения текстов.
- Валидация: проверка допустимых страниц (home, about, catalog, contacts) и языков (ru, en, ua).
- Кэширование: in-memory кэш с TTL 5 минут, инвалидация при изменениях.
- CRUD операции: UPSERT для сохранения, удаление пустых значений.
- AJAX: сохранение без перезагрузки страницы через fetch API.

Решения:
- Кэш реализован в `app/utils/cache.py` с thread-safe операциями и TTL.
- Валидация ключей текстов: title, subtitle, description, cta_text, phone, address.
- Автотест `tests/auto_tests/test_texts_editor.py` проверяет все компоненты системы.
- UI использует современный дизайн с уведомлениями об успехе/ошибках.

## Этап 5.1 — исправления редактора текстов

- **Проблемы:** Кнопка "Загрузить тексты" была избыточной, значения по умолчанию не установлены, сохранение данных не работало из-за неправильного SQL-запроса.
- **Исправления:**
  - Убрана кнопка "Загрузить тексты", добавлена автоматическая загрузка при открытии страницы.
  - Установлены значения по умолчанию: Главная страница + английский язык.
  - Исправлен SQL-запрос для сохранения данных (заменен ON CONFLICT на проверку существования записи).
  - Добавлена автоматическая загрузка данных при изменении страницы или языка.
- **Тестирование:** Создан автотест `tests/auto_tests/test_texts_editor_fixed.py` для проверки всех исправлений.
- **Результат:** Редактор текстов теперь работает корректно с автоматической загрузкой и сохранением данных.

## Этап 5.2 — исправление CSRF проблемы

- **Проблема:** API endpoints требовали CSRF токены, что вызывало ошибку 403 при сохранении текстов через JavaScript.
- **Причина:** CSRF middleware применялся ко всем запросам, включая API endpoints.
- **Исправление:** Добавлено исключение для API endpoints (`/cms/api/*`) в CSRF middleware.
- **Изменения:**
  - Обновлен `app/auth/csrf.py` - API endpoints пропускают CSRF проверку.
  - Убраны CSRF токены из JavaScript запросов в `app/templates/texts.html`.
  - Обычные формы (логин, регистрация) остаются защищенными CSRF.
- **Тестирование:** Создан автотест `tests/auto_tests/test_csrf_fix.py` для проверки исправления.
- **Результат:** Сохранение и загрузка текстов теперь работают без ошибок 403.

## Этап 6 — загрузка и управление изображениями

- **API endpoints:** Созданы endpoints для загрузки, получения, удаления и изменения порядка изображений (`/cms/api/images/*`).
- **Валидация:** Проверка типа файла (JPG, PNG, WebP, ICO), размера (максимум 2MB) и корректности изображения.
- **Оптимизация:** Автоматическая оптимизация изображений через Pillow с конвертацией в WebP (качество 80%, максимальная ширина 1920px).
- **Хранение:** Сохранение оригинальных файлов в `/uploads/originals` и оптимизированных в `/uploads/optimized`.
- **UI:** Полноценный интерфейс управления изображениями с drag-and-drop сортировкой для слайдера.
- **Кэширование:** In-memory кэш изображений с TTL 10 минут и автоматическая инвалидация при изменениях.
- **Типы изображений:** Поддержка типов logo, slider, background, favicon с отдельным управлением.
- **Тестирование:** Создан автотест `tests/auto_tests/test_images_management.py` для проверки всех компонентов.
- **Результат:** Полнофункциональная система управления изображениями с оптимизацией и кэшированием.

## Этап 7 — SEO-панель

- **API endpoints:** Созданы endpoints для получения и сохранения SEO данных (`/cms/api/seo`).
- **Валидация:** Проверка длин полей (title ≤ 60, description ≤ 160, keywords ≤ 255 символов) согласно SEO рекомендациям.
- **UI:** Полноценный интерфейс с формой редактирования и предпросмотром результатов в стиле Google Search.
- **Предпросмотр:** Реальное время отображения как будет выглядеть страница в поисковиках.
- **HTML генерация:** Автоматическая генерация HTML кода для мета-тегов.
- **Мультиязычность:** Поддержка SEO для всех страниц (home, about, catalog, contacts) и языков (ru, en, ua).
- **UPSERT операции:** Автоматическое создание или обновление SEO записей в таблице `seo`.
- **Тестирование:** Создан автотест `tests/auto_tests/test_seo_management.py` для проверки всех компонентов.
- **Результат:** Полнофункциональная SEO-панель с валидацией, предпросмотром и мультиязычной поддержкой.

## Этап 8 — управление пользователями и роли (admin)

- **API endpoints:** Созданы endpoints для управления пользователями (`/cms/api/users/*`):
  - `GET /cms/api/users` — получение списка пользователей (только admin)
  - `POST /cms/api/users` — создание нового пользователя (только admin)
  - `DELETE /cms/api/users/{user_id}` — удаление пользователя (только admin)
  - `POST /cms/api/users/{user_id}/reset-password` — сброс пароля пользователя (только admin)
- **Проверка ролей:** Все endpoints требуют роль admin, editor получает 403 Forbidden.
- **Валидация:** Проверка email, пароля (минимум 8 символов), роли (admin/editor), уникальности email.
- **Безопасность:** Запрет удаления самого себя, хэширование паролей через bcrypt.
- **UI интерфейс:** Полноценный интерфейс управления пользователями с таблицей, модальными окнами для создания и сброса пароля.
- **Разделение доступа:** Ссылка на раздел "Пользователи" в dashboard отображается только для admin.
- **AJAX операции:** Создание, удаление и сброс пароля без перезагрузки страницы.
- **Уведомления:** Система уведомлений об успехе/ошибках операций.
- **Тестирование:** Создан автотест `tests/auto_tests/test_users_management.py` для проверки всех компонентов.
- **Результат:** Полнофункциональная система управления пользователями с разделением доступа по ролям.

## Этап 9 — публичный сайт

- **Публичные роуты:** Созданы роуты для всех основных страниц сайта:
  - `/` — главная страница с hero-секцией и слайдером
  - `/about` — страница о компании с информацией и командой
  - `/catalog` — страница каталога с категориями товаров
  - `/contacts` — страница контактов с формой и информацией
- **Мультиязычность:** Реализованы алиасы для всех языков:
  - `/ru/`, `/en/`, `/ua/` — главная страница
  - `/ru/about`, `/en/about`, `/ua/about` — о компании
  - `/ru/catalog`, `/en/catalog`, `/ua/catalog` — каталог
  - `/ru/contacts`, `/en/contacts`, `/ua/contacts` — контакты
- **Хелперы для контента:** Созданы функции для работы с данными:
  - `get_text(page, key, lang)` — получение текстов с кэшированием
  - `get_seo_data(page, lang)` — получение SEO данных
  - `get_image(type, order)` — получение изображений по типу
  - `get_slider_images()` — получение всех изображений слайдера
- **Шаблоны:** Созданы полноценные шаблоны для всех публичных страниц:
  - `public/base.html` — базовый шаблон с навигацией и переключателем темы
  - `public/home.html` — главная страница с hero-секцией и слайдером
  - `public/about.html` — страница о компании
  - `public/catalog.html` — страница каталога
  - `public/contacts.html` — страница контактов
- **SEO интеграция:** Автоматическая вставка SEO тегов в шаблоны:
  - `<title>` из таблицы `seo`
  - `<meta name="description">` и `<meta name="keywords">`
  - Поддержка для всех страниц и языков
- **Кэширование:** In-memory кэш для текстов и SEO данных с TTL 5 минут.
- **Адаптивный дизайн:** Все шаблоны используют Tailwind CSS 4.1 с поддержкой темной темы.
- **Тестирование:** Создан автотест `tests/auto_tests/test_public_site.py` для проверки всех компонентов.
- **Результат:** Полнофункциональный публичный сайт с мультиязычностью, SEO и адаптивным дизайном.

## Этап 10 — мультиязычность

- **Language Middleware:** Создан middleware для автоматического определения языка из URL:
  - `LanguageMiddleware` — автоматическое извлечение языка из пути URL
  - Поддержка настраиваемых языков через переменные окружения
  - Сохранение языка в состоянии запроса для использования в роутах
- **Конфигурация языков:** Создан модуль `app/site/config.py`:
  - Настраиваемые языки через переменные окружения `SUPPORTED_LANGUAGES`
  - Язык по умолчанию через `DEFAULT_LANGUAGE`
  - Валидация поддерживаемых языков
- **Улучшенный переключатель языков:** Обновлен шаблон `public/base.html`:
  - Использование `language_urls` для корректной генерации ссылок
  - Автоматическое определение текущего языка
  - Поддержка всех страниц и языков
- **Автоматическое определение языка:** Все роуты обновлены для использования middleware:
  - Убраны параметры `lang` из функций роутов
  - Автоматическое получение языка из `request.state`
  - Генерация URL для всех языков через `get_language_urls_from_request()`
- **Кэширование локализованных блоков:** Интеграция с существующей системой кэширования:
  - Кэш текстов работает для каждого языка отдельно
  - SEO данные кэшируются по языкам
  - Автоматическая инвалидация при изменениях
- **Быстрое переключение языков:** Оптимизированная работа при частом переключении:
  - Middleware обрабатывает языки без дополнительных запросов к БД
  - Кэш ускоряет загрузку контента для каждого языка
  - Стабильная работа при быстром переключении между языками
- **Тестирование:** Создан автотест `tests/auto_tests/test_multilang.py` для проверки всех компонентов.
- **Результат:** Полнофункциональная мультиязычная система с автоматическим определением языка, быстрым переключением и кэшированием.

## Этап 10.1 — исправление сохранения языка в CMS

- **Проблема:** При переходах между страницами CMS не сохранялся выбранный язык.
- **Причина:** Отсутствовали языковые алиасы для CMS роутов и неправильная обработка в middleware.
- **Исправления:**
  - Добавлены языковые роуты для всех CMS страниц: `/cms/ru/`, `/cms/en/`, `/cms/ua/`, `/cms/ru/texts`, `/cms/en/texts`, etc.
  - Обновлен `LanguageMiddleware` для корректной обработки CMS роутов с языковыми префиксами.
  - Улучшена функция `_generate_language_urls()` для правильной генерации URL с языковыми префиксами.
- **Тестирование:** Создан автотест `tests/auto_tests/test_cms_language_persistence.py` для проверки сохранения языка при переходах.
- **Результат:** Языковое переключение в CMS теперь работает корректно с сохранением выбранного языка при переходах между страницами.

## Этап 11 — система кэширования

- **In-memory кэш с TTL:** Улучшенная система кэширования для текстов и изображений:
  - `TextCache` — кэш текстов с TTL 5 минут, поддержка инвалидации по странице/языку
  - `ImageCache` — кэш изображений с TTL 10 минут, поддержка инвалидации по типу
  - Thread-safe операции с использованием `Lock()`
  - Автоматическая очистка устаревших записей
- **Файловый кэш для рендеров:** Кэширование статичных рендеров страниц:
  - `FileCache` — сохранение HTML-контента в файлы JSON с метаданными
  - TTL 1 час для файлового кэша
  - Поддержка инвалидации по пути/языку
  - Автоматическая очистка поврежденных файлов
- **Метрики производительности:** Система измерения и статистики:
  - `CacheMetrics` — отслеживание hits/misses, времени рендера, hit rate
  - Декоратор `@measure_render_time` для автоматического измерения времени рендера
  - Статистика производительности с расчетом среднего времени рендера
- **Интеграция с роутами:** Автоматическая инвалидация кэша при изменениях:
  - Инвалидация текстового кэша при сохранении текстов
  - Инвалидация кэша изображений при загрузке/удалении
  - Инвалидация файлового кэша при изменении контента
  - Функция `invalidate_content_caches()` для централизованной инвалидации
- **API для управления:** Утилиты для работы с кэшем:
  - `get_cache_stats()` — получение общей статистики всех кэшей
  - `clear_all_caches()` — очистка всех кэшей
  - `invalidate_content_caches()` — селективная инвалидация
- **Тестирование:** Создан автотест `tests/auto_tests/test_caching_system.py`:
  - Проверка базовых операций кэша (set/get/invalidate)
  - Тестирование TTL и автоматической очистки
  - Проверка метрик производительности
  - Тестирование интеграции всех компонентов
  - Измерение производительности и speedup
- **Результат:** Полнофункциональная система кэширования с метриками, автоматической инвалидацией и файловым кэшем для статичных рендеров.